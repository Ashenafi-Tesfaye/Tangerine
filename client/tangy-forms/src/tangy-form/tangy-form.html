<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script src="tangy-form-model.js"></script>
<script src="tangy-form-response-model.js"></script>
<script src="tangy-form-service.js"></script>
<script src="tangy-form-actions.js"></script>
<link rel="import" href="tangy-form-item.html">
<link rel="import" href="../tangy-timed/tangy-timed.html">
<link rel="import" href="../tangy-gps/tangy-gps.html">
<link rel="import" href="../tangy-location/tangy-location.html">
<link rel="import" href="../tangy-checkbox/tangy-checkbox.html">
<link rel="import" href="../tangy-radio-buttons/tangy-radio-buttons.html">
<link rel="import" href="../tangy-eftouch/tangy-eftouch.html">
<script src="../tangy-toggle-button/tangy-toggle-button.js"></script>

<!-- dependencies -->
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/gold-phone-input/gold-phone-input.html">

<style>
  input:invalid {
    background-color: #e1e2e1;
  }
  paper-card {
    margin: 15px 0px;
    padding: 25px;
  }
  paper-checkbox {
    --paper-checkbox-checked-ink-color: #8BC34A;
    --paper-checkbox-checked-color: #8BC34A;
  }
  paper-radio-button {
    --paper-radio-button-checked-color: #8BC34A;
    --paper-radio-button-checked-ink-color: #8BC34A;
  }
  paper-input, paper-textarea {
    --paper-input-container-focus-color: #8BC34A;
  }
  label {
    display: block;
    margin-top: 15px;
    font-size: 12px;
    color: #777;
  }
</style>

<dom-module id="tangy-form">

  <template>
      <style>
        :host {
          background: #e1e2e1; 
          display: block;
          margin: 0px;
          padding: 0px;
        }
        #tangy-form--header {
          background: #e1e2e1; /* #ef6433; */
        }
        #tangy-form-responses, #tangy-form-questions {
          margin: 0px 20px;
          padding: 15px;
        }
        #tangy-form-questions--button-container {
          position: fixed;
          bottom: 15px;
          right: 0px;
        }
        #tangy-form-questions--progress {
          position: fixed;
          bottom: 0px;
          left: 0px;
          width: 100%;
        }
        #tangy-form-questions--form-container {
          display: block;
          max-width: 720px;
          margin: 0px auto;
        }
        #up-fab {
          background: #FF9800; 
          position: fixed;
          bottom: 73px;
          right: 7px;
          color: white;
        }
        #down-fab {
          background: #FF9800; 
          position: fixed;
          bottom: 10px;
          right: 7px;
          color: white;
        }
        :host([hide-nav]) #up-fab, 
        :host([hide-nav]) #down-fab {
          display: none;
        } 
        #show-responses-fab {
          background: #FF9800; 
          position: fixed;
          top: 73px;
          right: 7px;
        }
        #new-response-fab {
          background: #FF9800; 
          position: fixed;
          top: 10px;
          right: 7px;
        }
        :host([hide-responses]) #show-responses-fab, 
        :host([hide-responses]) #new-response-fab {
          display: none;
        } 
        paper-progress {
          --paper-progress-active-color: #FF9800;
        }
        paper-tab, paper-tabs {
          --paper-tabs-selection-bar-color: #FF9800 !important;
          color: #fff;
        }
        paper-button {
          background: #FF9800;
          --paper-button-ink-color: #FFF;
          color: #FFF;
        }
        paper-fab.expand-and-inform {
            -webkit-transform: scale3d(2, 2, 2);
            transform: scale3d(2, 2, 2);
        }
        paper-fab.shrink-to-tiny {
            -webkit-transform: scale3d(0.5, 0.5, 0.5);
            transform: scale3d(0.5, 0.5, 0.5);
        }
        paper-fab.shrink-to-normal {
            -webkit-transform: scale3d(1, 1, 1);
            transform: scale3d(1, 1, 1);
        }
        /*.expand-and-inform {*/
            /*-webkit-transform: scale3d(2, 2, 2);*/

      </style>
      <div id="tangy-form--header">
      </div>
      <div id="tangy-form-questions">
        <div id="tangy-form-questions--form-container">
          <slot id="tangy-form-questions--form"></slot>
        </div>
        <paper-fab id="new-response-fab" on-click="newResponse" icon="icons:add"></paper-fab>
        <paper-fab id="show-responses-fab" on-click="showResponses" icon="icons:save"></paper-fab>
        <div id="nav" hidden>
          <paper-fab id="up-fab" on-click="focusOnPreviousItem" icon="hardware:keyboard-arrow-up" hidden></paper-fab>
          <paper-fab id="down-fab" on-click="focusOnNextItem" icon="hardware:keyboard-arrow-down" hidden></paper-fab>
        </div>
        <paper-progress id="tangy-form-questions--progress" value="0" secondary-progress="100"></paper-progress>
      </div>
      <div id="tangy-form-responses" hidden>
        <paper-button on-click='newResponse' raised><iron-icon icon="icons:add"></iron-icon></paper-button>
        <paper-button on-click='generateCSV' raised><iron-icon icon="icons:file-download"></iron-icon></paper-button>
        <ul>
          <template is="dom-repeat" items="{{responses}}">
            <li> 
              [[item.startDatetime]]
              <iron-icon data-response-id="[[item._id]]" on-click="resumeResponse" icon="icons:launch"></iron-icon> 
              <template is="dom-if" if="{{item.isCurrentTangyFormResponse}}">
                <span style="color: #8BC34A;"> *</span>
              </template>
            </li>
          </template>
        </ul>
      </div>
  </template>

  <script>
    /**
     * `tangy-form`
     * An element used to encapsulate form elements for multipage forms with a response in PouchDB.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class TangyForm extends Polymer.Element {

      static get is() { return 'tangy-form'; }

      static get properties() {
        return {
          id: {
            type: String,
            value: 'tangy-form'
          },
          onChange: {
            type: String,
            value: '' 
          },
          database: {
            type: String,
            value: 'tangy-form'
          },
          responseId: {
            type: String,
            value: ''
          },
          linearMode: {
            type: Boolean,
            value: false
          },
          hideClosedItems: {
            type: Boolean,
            value: false
          },
          hideNav: {
            type: Boolean,
            value: false
          },
          hideResponses: {
            type: Boolean,
            value: false
          }
        };
      }

      async connectedCallback() {

        // @TODO Change this.id to this.form_id. It's more obvious.
        super.connectedCallback();

        // Stash initial state of innerHTML for use when starting a new response 
        // after a prior response was worked on.
        this._formDefinition = this.innerHTML

        // Set up the TangyFormService for interacting with TangyForm and TangyFormResponse docs in the database.
        // @TODO Rename database to databaseName.
        this.service = new TangyFormService({databaseName: this.database})
        await this.service.initialize()

        // Get our formDoc.
        this.formDoc = await this.service.getForm(this.id)

        // No formDoc? Create one. 
        if (!this.formDoc) {
          this.formDoc = new TangyFormModel({formId: this.id})
          this.formDoc = await this.service.saveForm(this.formDoc)
        }

        // Get the response doc. Covers the following scenarios.
        // A: We were given a response-id attribute but there is no response by that ID.
        // B: We were given a response-id attribute and there is a response by that ID.
        // C: We were not given a response-id attribute so we create a new response.

        // Determine our current response ID.
        if (!this.storeId && this.formDoc.responseId) {
          this.storeId = this.formDoc.responseId
        }

        // No response ID? Create one.
        if (!this.storeId) {
          this.store = new TangyFormResponseModel({formId: this.id})
          this.store = await this.service.saveResponse(this.store)
          // Now we definitely have a response ID.
          this.storeId = this.store._id
        }

        // Get our current response.
        this.store = await this.service.getResponse(this.storeId)

        // No response by this ID? Create it. Useful if someone made up a response ID.
        if (!this.store) {
          this.store = new TangyFormResponseModel({_id: this.storeId, formId: this.id})
          this.store = await this.service.saveResponse(this.store)
        }

        // Save this response as our current response.
        this.formDoc.responseId = this.store._id
        this.formDoc = await this.service.saveForm(this.formDoc)

        // Render the form.
        this.reset()
      }

      reset() {
        this.innerHTML = this._formDefinition
        this.applyState()
        [
          ITEM_OPEN,
          ITEM_OPENED,
          ITEM_CLOSE, 
          ITEM_CLOSED, 
          ITEM_DISABLE,
          INPUT_VALUE_CHANGE, 
          INPUT_DISABLE,
          INPUT_HIDE,
          NAVIGATE_TO_NEXT_ITEM,
          NAVIGATE_TO_PREVIOUS_ITEM
        ].forEach((eventType) => {
          this.addEventListener(eventType, (event) => this.reducer(this.store, event.detail))
        })
      }

      render(state) {
        if (this.linearMode) this.$['nav'].hidden = false
        this.querySelectorAll('tangy-form-item').forEach((item) => Object.assign(item, state.items[item.id]) )
        this.querySelectorAll('[name]').forEach((input) => Object.assign(input, state.inputs[inputs.id]) )
        this.$['tangy-form-questions--progress'].setAttribute('value', state.progress)
      }

      reducer(state, action) {
        this.store.log.push({type: eventType, detail, date: Date.now()})
        switch(action.type) {
          case ITEM_OPEN:
            break
          case ITEM_DISABLE:
            break
          case ITEM_CLOSE:
            break
          case INPUT_VALUE_CHANGE:
            let newState = Object.assign({}, state)
            newState.inputs[action.inputName] = action.inputValue 
            break
          case INPUT_DISABLE:
            break
          case INPUT_HIDE:
            break
          case NAVIGATE_TO_NEXT_ITEM:
            break
          case NAVIGATE_TO_PREVIOUS_ITEM:
            break
        }
        this.state = newState
        this.render(newState)
      }

      focusOnPreviousItem(event) {
        this.dispatch({ type: NAVIGATE_TO_PREVIOUS_ITEM })
      }

      focusOnNextItem(event) {
        this.dispatch({ type: NAVIGATE_TO_NEXT_ITEM })
      }

      // Helper function for dispatching action as a CustomEvent that bubbles.
      dispatch(action) {
        this.dispatchEvent(new CustomEvent(action.type, { bubbles: true, details: action }))
      }

      evalOnChangeAttribute() {
        let tangyForm = this
        let response = this.store
        let items = this.querySelectorAll('tangy-form-item')
        eval(this.onChange)// .bind(this)
      }

      updateItemNavigation() {
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        let focusItemIndex = items.findIndex(item => item.id == this.store.focusItemId)
        // Update progress.
        let progressCalculation = (parseInt(((focusItemIndex+1)/items.length)*100))
        this.$['tangy-form-questions--progress'].setAttribute('value', progressCalculation)
        // Update the next and back buttons.
        if (this.findNextItem(this.store.focusItemId)) {
          this.$['down-fab'].removeAttribute('disabled')
        }
        else {
          this.$['down-fab'].setAttribute('disabled', true)
        }
        if (this.findPreviousItem(this.store.focusItemId)) {
          this.$['up-fab'].removeAttribute('disabled')
        }
        else {
          this.$['up-fab'].setAttribute('disabled', true)
        }
      }

      /*
       * Responses helpers
       */

      async newResponse() {
        this.store = await this.service.saveResponse(new TangyFormResponseModel({formId: this.id}))
        this.formDoc = await this.service.getForm(this.id)
        this.formDoc.responseId = this.store._id
        this.formDoc = await this.service.saveForm(this.formDoc)
        this.render()
      }

      async resumeResponse(event) {
        let resumeResponseId = event.currentTarget.dataResponseId
        this.store = await this.service.getResponse(resumeResponseId)
        this.formDoc = await this.service.getForm(this.id)
        this.formDoc.responseId = this.store._id
        this.formDoc = await this.service.saveForm(this.formDoc)
        this.render()
      }

      async showResponses() {
        this.$['tangy-form-questions'].hidden = true 
        this.$['tangy-form-responses'].hidden = false 
        // @TODO Paginate and mark current response.
        this.stores = await this.service.getResponsesByFormId(this.id) 
      }

      async generateCSV() {
        this.stores = await this.service.getResponsesByFormId(this.id)
        let blob = new Blob([], {type: 'application/csv;charset=utf-8;' });
        // TODO: Scan for keys. Bonus points for doing it 100 sessions at a time.
        // Get header row.
        let keys = []
        for (let response of this.stores) {
          keys = _.uniq(keys.concat(Object.getOwnPropertyNames(response)))
        }
        // Get all data row.
        blob = new Blob([blob, keys.join(',') + '\n'], { type: 'application/csv;charset=utf-8;' });
        for (let response of this.stores) {
          let row = []
          // TODO: Loop through keys, assign empty values for nonmatching keys.
          for (let key of keys) {
            if (response.hasOwnProperty(key)) {
              let value = response[key]
              if (typeof value === 'object') value = JSON.stringify(value)
              if (typeof value === 'number') value = value.toString()
              // @TODO Using encodeURI for every string is a bummer, it makes output look weird.
              // value = value.replace(/"/g,'\\\"')
              // value = value.replace(/,/g,'\\,')
              value = encodeURI(value)
              row.push(`"${value}"`)
            } else {
              row.push('""')
            }
          }
          blob = new Blob([blob, row.join(',') + '\n'], { type: 'application/csv;charset=utf-8;' });
        }
        console.log('creating element');
        const element = window.document.createElement('a');
        element.setAttribute('href', URL.createObjectURL(blob));
        element.setAttribute('download', this.id + '.csv');
        console.log('appending to DOM');
        element.style.display = 'none';
        window.document.body.appendChild(element);
        console.log('Triggering download.');
        element.click();
        console.log('Cleaning up.');
        window.document.body.removeChild(element);
      }
    }

    const sleep = (ms) => new Promise((res, rej) => { 
      setTimeout(res, ms)
    })

    window.customElements.define(TangyForm.is, TangyForm);
  </script>
</dom-module>
