<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script src="tangy-form-response-model.js"></script>
<link rel="import" href="tangy-form-item.html">
<link rel="import" href="../tangy-timed/tangy-timed.html">
<link rel="import" href="../tangy-gps/tangy-gps.html">
<link rel="import" href="../tangy-location/tangy-location.html">
<link rel="import" href="../tangy-eftouch/tangy-eftouch.html">
<script src="../tangy-toggle-button/tangy-toggle-button.js"></script>

<!-- dependencies -->
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<style>
  input:invalid {
    background-color: #FF9800;
  }
  paper-card {
    margin: 15px 0px;
    padding: 25px;
  }
  paper-checkbox {
    --paper-checkbox-checked-ink-color: #8BC34A;
    --paper-checkbox-checked-color: #8BC34A;
  }
  paper-radio-button {
    --paper-radio-button-checked-color: #8BC34A;
    --paper-radio-button-checked-ink-color: #8BC34A;
  }
  paper-input, paper-textarea {
    --paper-input-container-focus-color: #8BC34A;
  }

</style>

<dom-module id="tangy-form">

  <template>
      <style>
        :host {
          background: #FF9800; 
          display: block;
          margin: 0px;
          padding: 0px;
        }
        #tangy-form--header {
          background: #FF9800; /* #ef6433; */
        }
        #tangy-form-responses, #tangy-form-questions {
          margin: 0px 20px;
          padding: 15px;
        }
        #tangy-form-questions--button-container {
          position: fixed;
          bottom: 15px;
          right: 0px;
        }
        #tangy-form-questions--progress {
          position: fixed;
          bottom: 0px;
          left: 0px;
          width: 100%;
        }
        #tangy-form-questions--form-container {
          display: block;
          max-width: 720px;
          margin: 0px auto;
        }
        #up-fab {
          background: #8BC34A; 
          position: fixed;
          bottom: 73px;
          right: 7px;
          color: white;
        }
        #down-fab {
          background: #8BC34A; 
          position: fixed;
          bottom: 10px;
          right: 7px;
          color: white;
        }
        #show-responses-fab {
          background: #8BC34A; 
          position: fixed;
          top: 73px;
          right: 7px;
        }
        #new-response-fab {
          background: #8BC34A; 
          position: fixed;
          top: 10px;
          right: 7px;
        }
        paper-progress {
          --paper-progress-active-color: #8BC34A;
        }
        paper-tab, paper-tabs {
          --paper-tabs-selection-bar-color: #8BC34A !important;
          color: #fff;
        }
        paper-button {
          background: #8BC34A;
        }
        paper-fab.expand-and-inform {
            -webkit-transform: scale3d(2, 2, 2);
            transform: scale3d(2, 2, 2);
        }
        paper-fab.shrink-to-tiny {
            -webkit-transform: scale3d(0.5, 0.5, 0.5);
            transform: scale3d(0.5, 0.5, 0.5);
        }
        paper-fab.shrink-to-normal {
            -webkit-transform: scale3d(1, 1, 1);
            transform: scale3d(1, 1, 1);
        }
        /*.expand-and-inform {*/
            /*-webkit-transform: scale3d(2, 2, 2);*/

      </style>
      <div id="tangy-form--header">
      </div>
      <div id="tangy-form-questions">
        <div id="tangy-form-questions--form-container">
          <slot id="tangy-form-questions--form"></slot>
        </div>
        <paper-fab id="new-response-fab" on-click="newResponse" icon="icons:add"></paper-fab>
        <paper-fab id="show-responses-fab" on-click="showResponses" icon="icons:save"></paper-fab>
        <paper-fab id="up-fab" on-click="focusOnPreviousItem" icon="hardware:keyboard-arrow-up"></paper-fab>
        <paper-fab id="down-fab" on-click="focusOnNextItem" icon="hardware:keyboard-arrow-down"></paper-fab>
        <paper-progress id="tangy-form-questions--progress" value="0" secondary-progress="100"></paper-progress>
      </div>
      <div id="tangy-form-responses" hidden>
        <paper-button raised><iron-icon on-click='newResponseButtonListener' icon="icons:add"></iron-icon></paper-button>
        <paper-button raised><iron-icon on-click='generateCSVButtonListener' icon="icons:file-download"></iron-icon></paper-button>
        <ul>
          <template is="dom-repeat" items="{{responses}}">
            <li> 
              [[item.startDatetime]]
              <paper-button data-response-id="[[item._id]]" on-click="resumeResponseButtonListener" raised><iron-icon icon="icons:launch"></iron-icon></paper-button> 
              <template is="dom-if" if="{{item.isCurrentTangyFormResponse}}">
                <span style="color: #8BC34A;"> *</span>
              </template>
            </li>
          </template>
        </ul>
      </div>
  </template>

  <script>
    /**
     * `tangy-form`
     * An element used to encapsulate form elements for multipage forms with a response in PouchDB.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class TangyForm extends Polymer.Element {

      static get is() { return 'tangy-form'; }

      static get properties() {
        return {
          id: {
            type: String,
            value: 'tangy-form'
          },
          src: {
            type: String,
            value: 'tangy-form'
          },
          onItemChange: {
            type: String,
            value: '' 
          },
          database: {
            type: String,
            value: 'tangy-form'
          },
          linearMode: {
            type: Boolean,
            value: false
          },
          hideClosedItems: {
            type: Boolean,
            valuse: false
          }
        };
      }

      async connectedCallback() {
        super.connectedCallback();
        // Use a PouchDB to store responses.
        this.db = new PouchDB(this.database)
        // Stash initial state of innerHTML for use when starting a new response 
        // after a prior response was worked on.
        this._formDefinition = this.innerHTML
        // Get the current response, else catch and create new response.
        let currentTangyFormResponse
        try {
          currentTangyFormResponse = await this.db.get(`current_tangy_form_response_${this.id}`);
        } catch (e) {
          let tangyFormResponse = new TangyFormResponseModel({
            formId: this.id
          })
          let dbResponse = await this.db.post(tangyFormResponse)
          tangyFormResponse = await this.db.get(dbResponse.id)
          dbResponse = await this.db.put({
            _id: `current_tangy_form_response_${this.id}`,
            responseId: tangyFormResponse._id
          })
          currentTangyFormResponse = await this.db.get(`current_tangy_form_response_${this.id}`);
        }
        this.response = await this.db.get(currentTangyFormResponse.responseId)
        this.render()
      }

      render() {
        this.$['tangy-form-responses'].hidden = true 
        this.$['tangy-form-questions'].hidden = false
        // Load items from item stash that was made on connected callback. Good for resuming fresh. 
        this.innerHTML = this._formDefinition
        // Load response data into items.
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        for (let item of items) {
          if (this.response.items.hasOwnProperty(item.id)) {
            item.response = this.response.items[item.id] 
          } else {
            this.response.items[item.id] = {}
          }
        }
        // Listen for Item Change events, save to response.
        this.addEventListener('tangy-form-item-variables-change', this.onItemVariablesChange)
        // If hideClosedItems, hide other items when one opens.
        if (this.hideClosedItems) {
          this.addEventListener('tangy-form-item-open-change', (event) => {
            items.forEach((item) => {
              if (!item.open) {
                item.style.display = 'none'
              } else {
                item.style.display = 'block'
              }
            })
          })
        }
        // If linearMode, turn off buttons on items.
        if (this.linearMode) {
          let items = this.querySelectorAll('tangy-form-items')
          for (item of items) item.noButtons = true
        }
        // Open last focused item or first item.
        if (this.response.focusItemId) {
          this.focusOnItem(this.response.focusItemId)
        } else {
          let firstItem = this.querySelector('tangy-form-item')
          this.focusOnItem(firstItem.id)
        }
      }

      async onItemVariablesChange(event) {
        this.response.items[event.srcElement.id] = event.srcElement.response
        await this.db.post(this.response)
        this.response = await this.db.get(this.response._id)
        // onItemChange logic.
        let tangyForm = this
        let response = this.response
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        eval(this.onItemChange)// .bind(this)
      }

      async focusOnItem(itemId) {
        // Close all items.
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        items.forEach((item) => item.removeAttribute('open'))
        // If there is another item we stuck on closing it, divert focus to invalid item.
        let stuckItemIndex = items.findIndex((item) => item.stuck == true)
        if (stuckItemIndex !== -1) itemId = items[stuckItemIndex].id
        // Get item to focus on.
        let item = this.querySelector(`#${itemId}`)
        // Save our new focus item ID.
        this.response.focusItemId = item.id 
        await this.db.put(this.response)
        this.response = await this.db.get(this.response._id);
        // Open item.
        if(!item.open) item.open = true
        // Update the nav.
        this.updateItemNavigation()
        // Scroll to the new item.
        await sleep(50)
        item.scrollIntoView({behavior: 'smooth', block: 'start'}) 
      }

      focusOnPreviousItem(event) {
        let previousItem = this.findPreviousItem(this.response.focusItemId)
        this.focusOnItem(previousItem.id)
      }

      focusOnNextItem(event) {
        let nextItem = this.findNextItem(this.response.focusItemId)
        this.focusOnItem(nextItem.id)
      }

      findNextItem(relativeItemId) {
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        let relativeItemIndex = items.findIndex(item => item.id == relativeItemId)
        let nextItemIndex = relativeItemIndex + 1
        while(items[nextItemIndex] && items[nextItemIndex].disabled) nextItemIndex++
        if (items[nextItemIndex]) {
          return items[nextItemIndex]
        } else {
          return false
        }
      }

      findPreviousItem(relativeItemId) {
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        let relativeItemIndex = items.findIndex(item => item.id == relativeItemId)
        let previousItemIndex = relativeItemIndex - 1
        while(items[previousItemIndex] && items[previousItemIndex].disabled) previousItemIndex--
        if (items[previousItemIndex]) {
          return items[previousItemIndex]
        } else {
          return false
        }
      }

      updateItemNavigation() {
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        let focusItemIndex = items.findIndex(item => item.id == this.response.focusItemId)
        // Update progress.
        let progressCalculation = (parseInt(((focusItemIndex+1)/items.length)*100))
        this.$['tangy-form-questions--progress'].setAttribute('value', progressCalculation)
        // Update the next and back buttons.
        if (this.findNextItem(this.response.focusItemId)) {
          this.$['down-fab'].removeAttribute('disabled')
        }
        else {
          this.$['down-fab'].setAttribute('disabled', true)
        }
        if (this.findPreviousItem(this.response.focusItemId)) {
          this.$['up-fab'].removeAttribute('disabled')
        }
        else {
          this.$['up-fab'].setAttribute('disabled', true)
        }
      }

      async newResponse() {
        let currentTangyFormResponse
        try {
          currentTangyFormResponse = await this.db.get(`current_tangy_form_response_${this.id}`);
        }
        catch (e) {
          await this.db.post({
            _id: `current_tangy_form_response_${this.id}`
          })
          currentTangyFormResponse = await this.db.get(`current_tangy_form_response_${this.id}`);
        }
        // Create the new response.
        let tangyFormResponse = new TangyFormResponseModel({
          formId: this.id
        })
        this.response = await this.db.get((await this.db.post(tangyFormResponse)).id)
        currentTangyFormResponse.responseId = this.response._id 
        await this.db.put(currentTangyFormResponse)
        this.render()
      }

      async resumeResponse(event) {
        let currentTarget = event.currentTarget
        let currentTangyFormResponse = await this.db.get(`current_tangy_form_response_${this.id}`);
        currentTangyFormResponse.responseId = currentTarget.dataResponseId
        await this.db.put(currentTangyFormResponse)
        this.response = this.db.get(currentTangyFormResponse.responseId)
        this.render()
      }

      async showResponses() {
        this.$['tangy-form-questions'].hidden = true 
        this.$['tangy-form-responses'].hidden = false 
        let currentResponse = await this.db.get(`current_tangy_form_response_${this.id}`);
        // @TODO Query for form response docs with `doc.form_id` equal to `this.form_id`.
        let allDocs = (await this.db.allDocs({include_docs: true})).rows.map((row) => { return row.doc})
        allDocs.sort(function (a, b) {
          return b.startUnixtime - a.startUnixtime;
        });
        this.responses = allDocs.filter((doc) => {
          if (doc.collection === 'TangyFormResponse' && doc.formId == this.id) {
            if (doc._id == currentResponse.responseId) {
              doc.isCurrentTangyFormResponse = true
            } else {
              doc.isCurrentTangyFormResponse = false
            }
            return doc
          }
        }) 
      }

    }

    const sleep = (ms) => new Promise((res, rej) => { 
      setTimeout(res, ms)
    })

    window.customElements.define(TangyForm.is, TangyForm);
  </script>
</dom-module>
