<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script src="tangy-form-model.js"></script>
<script src="tangy-form-response-model.js"></script>
<script src="tangy-form-service.js"></script>
<script src="tangy-form-reducer.js"></script>
<script src="tangy-form-actions.js"></script>
<script src="../../node_modules/redux/dist/redux.js"></script>

<link rel="import" href="tangy-form-item.html">
<link rel="import" href="../tangy-timed/tangy-timed.html">
<link rel="import" href="../tangy-gps/tangy-gps.html">
<link rel="import" href="../tangy-location/tangy-location.html">
<link rel="import" href="../tangy-checkbox/tangy-checkbox.html">
<link rel="import" href="../tangy-radio-buttons/tangy-radio-buttons.html">
<link rel="import" href="../tangy-eftouch/tangy-eftouch.html">
<script src="../tangy-toggle-button/tangy-toggle-button.js"></script>

<!-- dependencies -->
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/gold-phone-input/gold-phone-input.html">

<style>
  input:invalid {
    background-color: #e1e2e1;
  }
  paper-card {
    margin: 15px 0px;
    padding: 25px;
  }
  paper-checkbox {
    --paper-checkbox-checked-ink-color: #8BC34A;
    --paper-checkbox-checked-color: #8BC34A;
  }
  paper-radio-button {
    --paper-radio-button-checked-color: #8BC34A;
    --paper-radio-button-checked-ink-color: #8BC34A;
  }
  paper-input, paper-textarea {
    --paper-input-container-focus-color: #8BC34A;
  }
  label {
    display: block;
    margin-top: 15px;
    font-size: 12px;
    color: #777;
  }
</style>

<dom-module id="tangy-form">

  <template>
      <style>
        :host {
          background: #e1e2e1; 
          display: block;
          margin: 0px;
          padding: 0px;
        }
        #nextItemButton {
          background: #FF9800; 
          position: fixed;
          bottom: 73px;
          right: 7px;
          color: white;
        }
        #previousItemButton {
          background: #FF9800; 
          position: fixed;
          bottom: 10px;
          right: 7px;
          color: white;
        }
        :host(:not([linear-mode])) #nextItemButton,
        :host(:not([linear-mode])) #previousItemButton
         {
          display: none;
        }
        #progress {
          position: fixed;
          top: 0px;
        }
        paper-progress {
          --paper-progress-active-color: #FF9800;
          width: 100%;
        }
        paper-tab, paper-tabs {
          --paper-tabs-selection-bar-color: #FF9800 !important;
          color: #fff;
        }
      </style>
      <slot></slot>
      <div id="nav">
        <paper-fab id="nextItemButton" on-click="focusOnPreviousItem" icon="hardware:keyboard-arrow-up"></paper-fab>
        <paper-fab id="previousItemButton" on-click="focusOnNextItem" icon="hardware:keyboard-arrow-down"></paper-fab>
      </div>
      <paper-progress id="progress" value="0" secondary-progress="100"></paper-progress>
  </template>

  <script>
    /**
     * `tangy-form`
     * An element used to encapsulate form elements for multipage forms with a response in PouchDB.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class TangyForm extends Polymer.Element {

      static get is() { return 'tangy-form'; }

      static get properties() {
        return {
          onChange: {
            type: String,
            value: '' 
          },
          hideClosedItems: {
            type: Boolean,
            value: false
          },
          linearMode: {
            type: Boolean,
            value: false
          }
        };
      }

      constructor() {
        super()
        this.fire = false
        this.loaded = false
      }

      async connectedCallback() {
        super.connectedCallback()
        this.db = new PouchDB('tangy-form')
        // Wait until the slot content has passed through.
        while (this.innerHTML == '') await sleep(1000)
        while (this.innerHTML == window.tangyFormStore) await sleep(1000)
        while (!window.tangyFormStore) await sleep(1000)
        while (!window.tangyFormStore.subscribe) await sleep(1000)
        console.log('every set up')
        if (this.hideNav) this.$['nav'].hidden = true 
        // Set up the store.
        this.store = window.tangyFormStore
        
        let state = this.store.getState()
        try {
          let session = await this.db.get(state._id)
          this.store.dispatch({type: FORM_SESSION_RESUME, session: session})
        } catch (e) {
          this.db.put(state)
        }
        this.store.subscribe(this.throttledSave.bind(this))
        this.store.subscribe(() => this.throttledUpdate(this))
        this.querySelectorAll('tangy-form-item').forEach((item) => {
          item.addEventListener('INPUT_VALUE_CHANGE', this.evalOnChangeAttribute.bind(this))
          if (this.linearMode) item.noButtons = true
        })
        this.store.dispatch({type: FORM_OPEN, items: this.querySelectorAllSerialized('tangy-form-item')})
      }

      evalOnChangeAttribute() {
        let state = this.store.getState()
        eval(this.onChange)
      }

      // Prevent parallel saves which leads to race conditions.
      async throttledSave() {
        // If already loaded, return.
        if (this.throttledSaveLoaded) return
        // Throttle this fire by waiting until last fire is done.
        if (this.throttledSaveFiring) {
          this.throttledSaveLoaded = true
          while(this.throttledSaveFiring) await sleep(200)
          this.throttledSaveLoaded = false
        }
        // Fire it.
        this.throttledSaveFiring = true
        await this.save()
        this.throttledSaveFiring = false
      }

      async save() {
        const state = this.store.getState()
        let stateDoc = {}
        try {
          stateDoc = await this.db.get(state._id)
        } catch(e) {
          let r = await this.db.put(state)
          stateDoc = await this.db.get(state._id)
        }
        let newStateDoc = Object.assign({}, state, { _rev: stateDoc._rev })
        await this.db.put(newStateDoc)
      }

      // Prevent parallel updates which leads to race conditions.
      async throttledUpdate() {
        if (this.throttledUpdateFiring) {
          this.throttledUpdateLoaded = true
          return
        } 
        // Fire it.
        this.throttledUpdateFiring = true
        await this.update()
        this.throttledUpdateFiring = false
        while (this.throttledUpdateLoaded === true) {
          this.throttledUpdateFiring = true
          await this.update()
          this.throttledUpdateFiring = false
          this.throttledUpdateLoaded = false
        }
      }

      async update() {
        let state = this.store.getState()
        if (!this.previousState) this.previousState = state
        // Set state in tangy-form-item elements.
        let items = [].slice.call(this.querySelectorAll('tangy-form-item'))
        items.forEach((item) => {
          let index = state.items.findIndex((itemState) => item.id == itemState.id) 
          if (index !== -1) Object.assign(item, state.items[index])
        })
        // Set state in input elements.
        let inputs = [].slice.call(this.querySelectorAll('[name]'))
        inputs.forEach((input) => {
          let index = state.inputs.findIndex((inputState) => inputState.name == input.name) 
          if (index !== -1) Object.assign(input, state.inputs[index])
        })
        this.$.progress.setAttribute('value', state.progress)
        if (this.hideClosedItems) {
          items.forEach((item) => {
            if (item.open) {
              item.style.display = 'block'
            } else {
              item.style.display = 'none'
            }
          })
        }
        if (state.focusId !== this.previousState.focusId) {
          let item = this.querySelector(`#${state.focusId}`)
          await sleep(200)
          if (item) item.scrollIntoView({behavior: 'smooth', block: 'start'})
        }  
        this.previousState = Object.assign({}, state)
      }

      focusOnPreviousItem(event) {
        this.store.dispatch({ type: NAVIGATE_TO_PREVIOUS_ITEM })
      }

      focusOnNextItem(event) {
        this.store.dispatch({ type: NAVIGATE_TO_NEXT_ITEM })
      }

      querySelectorAllSerialized(selector) {
        let elements = this.querySelectorAll(selector)
        let serializedElements = []
        elements.forEach((element) => {
          let serializedElement = {}
          let attributes = [].slice.call(element.attributes)
          attributes.forEach((attr) => serializedElement[attr.name] = attr.value)
          serializedElements.push(serializedElement)
        })
        return serializedElements
      }

      getInputValue(name) {
        let state = this.store.getState()
        let input = state.inputs.find((input) => input.name == name)
        if (input) return input.value
      }

    }

    const serializeElement = (element) => {
      let attributes = [].slice.call(element.attributes)
      let serial = {}
      attributes.forEach((attr) => serial[attr.name] = attr.value)
      return serial
    }
    window.customElements.define(TangyForm.is, TangyForm);
  </script>
</dom-module>
