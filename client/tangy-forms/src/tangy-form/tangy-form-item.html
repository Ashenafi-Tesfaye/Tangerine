<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<style>
  paper-input {
    margin-bottom: 15px;
  }
  paper-radio-button {
    margin: 0px 15px 0px 0px;
  }
</style>
   
<dom-module id="tangy-form-item">
  
  <template>
    <style>
      :host {
        padding: 15px;
        min-height: 100vh;
      }
      paper-input {
        margin-bottom: 15px;
      }
      :host paper-card {
        -webkit-transition: .4s;
        -moz-transition: .4s;
        -ms-transition: .4s;
        -o-transition: .4s;
        display: block;
        --paper-card-background-color: #FFF;
        --paper-card-header-color: #8BC34A;
        max-width: 325px;
        margin: 30px auto;
      }
      :host([valid]) paper-card {
      }
      :host([stuck]) paper-card {
        --paper-card-background-color: #ffebea;
      }
      :host([disabled]) paper-card {
        --paper-card-background-color: gray !important;
        --paper-card-header-color: #CCC;
      }
      :host([open]) paper-card {
        -webkit-transition: .4s;
        -moz-transition: .4s;
        -ms-transition: .4s;
        -o-transition: .4s;
        display: block;
        max-width: 720px;
        margin: 30px auto;
        --paper-card-background-color: #FFF !important;
        --paper-card-header-color: #8BC34A;
        color: #000;
      }
      :host([open]) #open {
        display: none;
      }
      :host(:not([open])) #close {
        display: none;
      }
      :host([disabled]) #open {
        display: none;
      }
      :host([no-buttons]) #open,
      :host([no-buttons]) #close {
        display: none;
      }
      paper-button {
        background: #FF9800;
        --paper-button-ink-color: #FFF;
        color: #FFF;
      }
    </style>
    <paper-card id="card" class="shrunk" heading="[[title]]">
      <div class="card-content">
        <slot></slot>
      </div>
      <div class="card-actions">
        <paper-button id="open">open</paper-button>
        <paper-button id="close">submit</paper-button>
      </div>
    </paper-card>
  </template>

  <script>
    /**
     * `tangy-form-item`
     * An element used to encapsulate form elements for multipage forms with a response in PouchDB.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class TangyFormItem extends Polymer.Element {

      static get is() { return 'tangy-form-item'; }
      static get properties() {
        return {
          src: {
            type: String,
            value: 'tangy-form-item'
          },
          title: {
            type: String,
            value: ''
          },
          responseJson: {
            type: String,
            value: '{}',
            observer: 'onResponseJsonChange'
          },
          open: {
            type: Boolean,
            value: false,
            observer: 'onOpenChange',
            reflectToAttribute: true
          },
          valid: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          stuck: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          disabled: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          noButtons: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          }
        };
      }

      async connectedCallback() {
        super.connectedCallback()
        if (this.responseJson) {
          this.response = JSON.parse(this.responseJson)
        } else {
          this.response = {}
        }
        this.$.close.addEventListener('click', () => {
          this.open = false
        })
        this.$.open.addEventListener('click', () => {
          if (this.disabled) return
          this.open = true 
        })
      }

      closeIt() {
        this.valid = this.validate() 
        if (this.valid === true) {
          this.stuck = false
          this.innerHTML = '' 
        } else {
          // User is stuck with this item open.
          this.stuck = true
          this.open = true
        }
      }

      async openIt() {
        // Put item HTML in a template element first so we can prepopulate it with data.
        let template = document.createElement('template')
        let response = await fetch(this.src)
        template.innerHTML = await response.text()
        let formTemplate = template.content.querySelector('form')
        this.setResponse(formTemplate)
        this.innerHTML = template.innerHTML
        // @TODO Necessary?
        let htmlForm = this.querySelector('form')
        htmlForm.getResponse = this.getResponse.bind(this)
        // @TODO Necessarry?
        this.$.card.classList.add('open')
        // Dispatch the change event to the form so now that it has been prepopulated and rendered, any logic in
        // htmlForm.onchange has a chance to run.
        htmlForm.dispatchEvent(new Event('change'))
        // Listen for change events, set data to response.
        htmlForm.addEventListener('change', this.formChangeListener.bind(this))
        // Notify anything watching that we are all done opening.
        this.dispatchEvent(new CustomEvent('tangy-form-item-open-change', {bubbles: true}))
      }

      async onOpenChange(newValue, oldValue) {
        // Close it.
        if (newValue === false && oldValue === true) {
          this.closeIt()  
        }
        // Open it.
        if (newValue == true && oldValue === false && this.stuck === false) {
          this.openIt()
        }
      }

      formChangeListener(event) {
        this.response = this.getResponse()  
        // Native HTML Form does not dispatch a change event when non native input elements change. Force it to.
        // @TODO: If we can detect this is a native input element that change, then don't do this.
        let htmlForm = this.querySelector('form')
        if (htmlForm) {
          htmlForm.response = this.response
          //htmlForm.dispatchEvent(new Event('change'))
        }
        this.dispatchEvent(new CustomEvent('tangy-form-item-variables-change', {bubbles: true}))
      }

      validate() {
        let isValid = true 
        let inputs = this.querySelectorAll('[name]') 
        for (let input of inputs) {
          if (typeof input.validate == 'function' && !input.validate()) isValid = false 
        }
        return isValid
      }

      getResponse() {
        let inputs = this.querySelectorAll('[name]') 
        let response = {}
        for (let input of inputs) {
          response[input.name] = input.value
        }
        return response 
      }

      setResponse(formTemplate) {
        // Get all elements with a name attribute.
        let inputs = formTemplate.querySelectorAll('[name]') 
        for (let input of inputs) {
          if (this.response[input.attributes.name.value]) {
            input.attributes.value.value = this.response[input.attributes.name.value]
          }
        }
      }

    }

    window.customElements.define(TangyFormItem.is, TangyFormItem);
  </script>
</dom-module>
