<link rel="import" href="../tangy-form/tangy-form.html">
<link rel="import" href="../tangy-form/tangy-form-item.html">
<link rel="import" href="../tangy-form/tangy-textarea.html">

<!-- dependencies -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!--<script src="../../node_modules/ckeditor5-build-classic/build/ckeditor.js/ckeditor.js"></script>-->
<script src="../../bower_components/pouchdb/dist/pouchdb.js"></script>

<dom-module id="tangy-form-app">
  <style>
    body {
      background: #F4F4F4;
      padding: 0px;
      margin: 0px;
      scroll-behavior: smooth; 
    }
  </style>

  <template>
    <style>
      :host {
        display: block;
      }
      .form-link {
        background: #FF9800;
        padding: 15px;
        margin: 15px;
      }
      paper-card {
        border: 1px solid #FF9800;
        --paper-card-header-color: #fff !important;
      }
      paper-card:hover {
        border: 1px solid #8BC34A;
      }
      paper-card .card-actions {
        text-align: center;
        color: #fff;
      }
      .settings {
        position: relative;
        /*left: 45px;*/
        top: 8px;
        margin:auto;
      }
      .launch-form {
        position: relative;
        /*left: 45px;*/
        top: 8px;
        margin:auto;
      }
      #form-view--nav {
        font-weight: heavy;
        font-size: 1.2em;
        padding: 15px;
        color: #FFF;
        background: #FF9800;
      }
      /*#.horizontal {*/
        /*--demo-snippet-demo: {*/
          /*@apply --layout-horizontal;*/
          /*@apply --layout-justified;*/
          /*@apply --layout-wrap;*/
        /*}*/
      /*}*/
      /*demo-snippet.horizontal paper-input {*/
        /*display: inline-block;*/
      /*}*/
      .item-container {
        @apply(--layout-horizontal);
      }
      .flexchild {
        @apply(--layout-flex);
      }
      .flex2child {
        @apply(--layout-flex-2);
      }
      div[role="listbox"] {
        border: 1px solid #e5e5e5;
      }
      .avatar {
        display: inline-block;
        box-sizing: border-box;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--paper-amber-500);
      }

      .blue {
        background-color: var(--paper-light-blue-300);
      }
      paper-input {
        max-width: 600px;
        margin: auto;
      }
      paper-textarea {
        max-width: 600px;
        margin: auto;
      }
      paper-button {
        min-width: 0em;
        margin: auto;
        margin-left: -15px;
      }
      paper-icon-item.newItem {
        --paper-item-body-secondary-color: {
          background: var(--paper-amber-500);
        };
      }
      paper-item-body.newItem {
        --paper-item-body-secondary-color: {
          background: var(--paper-amber-500);
        };
      }
      paper-item-body {
        --paper-item-body-secondary-color: {
          color: #0e90d2;
        };
      }
    </style>
    <div class="tangy-form-app--container">
      <div id="form-list">
        <template is="dom-if" if="{{forms.size > 1}}">
          <template is="dom-repeat" items="{{forms}}">
            <paper-card
                    class="form-link"
                    image="../client/images/noun_1018421_cc-small.png"
                    alt="[[item.title]]"
                    heading="[[item.title]]">
              <div class="card-actions">
                <paper-button
                        class="settings"
                        data-form-src="[[item.src]]"
                        data-form-title="[[item.title]]"
                        on-click="editFormListener">
                  <iron-icon icon="icons:settings"/>
                </paper-button>
                <paper-button
                        class="launch-form"
                        data-form-src="[[item.src]]"
                        data-form-title="[[item.title]]"
                        on-click="showFormListener">
                  <iron-icon icon="icons:launch"/>
                </paper-button>
              </div>
            </paper-card>
          </template>
        </template>

        <template is="dom-repeat" items="{{editorForms}}">
          <paper-card
                  class="form-link"
                  image="../client/images/noun_1018421_cc-small.png"
                  alt="[[item.title]]"
                  heading="[[item.title]]">
            <div class="card-actions">
              <paper-button
                      class="settings"
                      data-form-src="[[item.src]]"
                      data-form-title="[[item.title]]"
                      on-click="editFormListener">
                <iron-icon icon="icons:settings"/>
              </paper-button>
            </div>
          </paper-card>
        </template>
      </div>

      <div id="form-view" hidden>

        <div id="form-view--nav">
          <iron-icon icon="icons:close" on-click="showFormsList"></iron-icon>
          [[headerTitle]]
        </div>
        <slot></slot>
      </div>

      <div id="form-edit" hidden>
        <app-header reveals>
          <app-toolbar>
            <paper-icon-button icon="menu" onclick="drawer.toggle()"></paper-icon-button>
            <div main-title>[[headerTitle]]</div>
            <paper-icon-button
                    icon="add-circle-outline"
                    data-form-src="[[formHtmlPath]]"
                    data-item-title="New Item"
                    data-form-src=null
                    data-item-src=null
                    data-item-order=null
                    on-click="editFormItemListener">
            </paper-icon-button>
            <paper-icon-button icon="close" on-click="showFormsList"></paper-icon-button>
          </app-toolbar>
        </app-header>

        <template is="dom-if" if="{{items.size > 1}}">
          <div role="listbox">
          <template is="dom-repeat" items="{{items}}">
                <paper-icon-item
                        class="[[item.class]]"
                        on-click="editFormItemListener"
                        data-item-id="[[item.id]]"
                        data-form-src="[[item.formSrc]]"
                        data-item-src="[[item.src]]"
                        data-item-order="[[item.itemOrder]]"
                        data-item-title="[[item.title]]">
                  <div class="avatar blue" slot="item-icon"></div>
                  <paper-item-body
                          two-line
                          class="[[item.class]]"
                          on-click="editFormItemListener"
                          data-item-id="[[item.id]]"
                          data-form-src="[[item.formSrc]]"
                          data-item-src="[[item.src]]"
                          data-item-order="[[item.itemOrder]]"
                          data-item-title="[[item.title]]">
                    <div>[[item.title]]</div>
                    <div secondary>[[item.src]]</div>
                  </paper-item-body>
                </paper-icon-item>
          </template>
          </div>
        </template>
      </div>

      <div id="item-edit" hidden>
        <app-header reveals>
          <app-toolbar>
            <paper-icon-button icon="menu" onclick="drawer.toggle()"></paper-icon-button>
            <div main-title>[[headerTitle]]</div>
            <paper-icon-button icon="close" on-click="showFormsList"></paper-icon-button>
          </app-toolbar>
        </app-header>

          <div style="width: 600px;margin-left: auto; margin-right: auto;">
            <form id="itemEditor">
              <paper-button
                      data-item-src="[[itemFilename]]"
                      data-item-id="[[itemId]]"
                      on-tap="saveItem">
                <iron-icon icon="icons:save"/>
              </paper-button>
              <paper-input id="itemTitle" value="{{itemTitle}}" label="title"  always-float-label></paper-input>
              <paper-input id="itemOrder" value="{{itemOrder}}" label="order" always-float-label disabled$="{{itemOrderDisabled}}"></paper-input>
              <!--<exmg-ckeditor id="itemHtml" value="{{itemHtmlText}}" label="html code" always-float-label></exmg-ckeditor>-->
              <tangy-textarea value="{{itemHtmlText}}"></tangy-textarea>
            </form>
          </div>
      </div>
    </div>

  </template>

  <script>

    class TangyUtils {

      static async saveItem(item, items) {
        // Check if this is a new item
        if (typeof item.itemId == 'undefined') {
          // todo : create filename from item title using sanitize
          let len = items.length + 1
          item.itemId= 'item-' + len
          item.itemFilename = item.itemId + '.html'
        }
        let response = await fetch("/editor/item/save", {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          method: "POST",
          body: JSON.stringify(item)
        });
        return response;
      };
    }


    /**
     * `tangy-form-app`
     * ... 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class TangyFormApp extends Polymer.Element {

      static get is() { return 'tangy-form-app'; }

      static get properties() {
        return {
          database: {
            type: String,
            value: 'tangy-form'
          },
          forms: {
            type: Array,
            value: []
          },
          items: {
            type: Array,
            value: []
          },
          editorForms: {
            type: Array,
            value: []
          },
          headerTitle: {
            type: String,
            value: '',
          },
          form: {
            type: Object,
          },
          formSrc: {  // path to form.html, used in Form listing.
            type: String,
            value: '',
            observer: 'onFormSrcChange'
          },
          formHtmlPath: { // path to form.html - e.g.: "formHtmlPath":"forms/lemmie/form.html"
            type: String,
            value: '',
          },
          itemFilename: { // "itemFilename":"item-1.html",
            type: String,
            value: '',
            observer: 'onItemFilenameChange'
          },
          itemId: { // "itemId":"item-1"
            type: String,
            value: '',
          },
          itemHtml: { // id of textarea for html content
            type: String,
            value: '',
            observer: 'onItemHtmlChange'
          },
          itemHtmlText: { // html code from textarea
            type: String,
            value: '',
          },
          itemTitle: { // "itemTitle":"ACASI Part 3: Introduction"
            type: String,
            value: '',
          },
          itemOrder: {  // item order in form
            type: Number,
            value: '',
          },
          itemOrderDisabled: {  // item order in form
            type: Boolean,
            value: false,
          }
        };
      }
      
      connectedCallback() {
        super.connectedCallback(); 
        if (window.location.hash) {
          this.formSrc = (window.location.hash).replace('#', '')
        } else {
          this.showFormsList()
        }
      }

      onFormSrcChange(newValue, oldValue) {
        if (newValue !== '') this.showForm(newValue)
      }

      onItemFilenameChange(newValue, oldValue) {
        if (newValue !== '') this.editItem(newValue)
      }

      onItemHtmlChange(newValue, oldValue) {
        if (newValue !== '') this.saveItem(newValue)
      }

      async showFormListener(event) {
        window.location.hash = event.currentTarget.dataFormSrc
        this.formSrc = event.currentTarget.dataFormSrc
      }
      async editFormListener(event) {
//        window.location.hash = event.currentTarget.dataFormSrc
        this.formHtmlPath = event.currentTarget.dataFormSrc
        this.editForm(this.formHtmlPath)
      }
      async editFormItemListener(event) {
//        window.location.hash = event.currentTarget.dataFormSrc
        this.formHtmlPath = event.currentTarget.dataFormSrc
        this.itemFilename = event.currentTarget.dataItemSrc
        this.itemId = event.currentTarget.dataItemId
        this.itemOrder = event.currentTarget.dataItemOrder
        this.itemTitle = event.currentTarget.dataItemTitle
      }

      async showFormsList() {
        this.headerTitle = "Form Listing"
        this.$['form-view'].hidden = true
        this.$['form-list'].hidden = false
        this.$['form-edit'].hidden = true
        this.$['item-edit'].hidden = true
        document.querySelector("#content").setAttribute('style', 'display:none;')
        // Load forms list.
        let formsJson = await fetch('forms.json')
        this.forms = await formsJson.json()
//          Load editor forms
        let editorJson = await fetch('../client/editor-forms.json')
        this.editorForms = await editorJson.json()
      }

      async showForm(formSrc) {
        this.$['form-view'].hidden = false
        this.$['form-edit'].hidden = true
        this.$['item-edit'].hidden = true
        this.$['form-list'].hidden = true
        document.querySelector("#content").setAttribute('style', 'display:none;')
        // Load the form into the DOM.
        let formHtml = await fetch(formSrc)
        this.innerHTML = await formHtml.text()
        // Prepend the form src directory to the item src paths because item paths are relative to the form's directory.
        const formDirectory = formSrc.substring(0, formSrc.lastIndexOf('\/'))
        let tangyForm = this.querySelector('tangy-form')
        tangyForm.setAttribute('items-base-path', formDirectory)
      }

      async editForm(formSrc) {
        this.$['form-view'].hidden = true
        this.$['form-edit'].hidden = false
        this.$['item-edit'].hidden = true
        this.$['form-list'].hidden = true
        document.querySelector("#content").setAttribute('style', 'display:none;')
        // Load the form into a temp DOM to get stuff out of it
        let formHtml = await fetch(formSrc)
        let innerHTML = await formHtml.text()
        this.form = innerHTML
        var doc = document.implementation.createHTMLDocument("New Document");
        doc.documentElement.innerHTML = innerHTML;
        let itemsNode = doc.querySelectorAll("tangy-form-item");
        this.items = []
//        let newItem = {}
//        newItem.title = 'New Item'
//        newItem.class='newItem'
//        this.items.push(newItem)
        for (let node of itemsNode) {
          let item = {}
          item.id = node.getAttribute('id')
          item.src = node.getAttribute('src')
          item.title = node.getAttribute('title')
          item.itemOrder = node.getAttribute('itemOrder')
          item.formSrc = formSrc
          this.items.push(item)
        }
        this.headerTitle = "Item Listing"
      }

      /**
       * This can be used to create new items or edit items.
       * @param itemSrc
       * @returns {Promise.<void>}
       */
      async editItem(itemSrc) {
        this.$['form-view'].hidden = true
        this.$['form-edit'].hidden = true
        this.$['item-edit'].hidden = false
        this.$['form-list'].hidden = true
        let content = document.querySelector("#content")
        content.setAttribute('style', 'display:block;width: 600px;margin-left: auto; margin-right: auto;')
        let tangyFormApp = document.querySelector("tangy-form-app")
        tangyFormApp.setAttribute('style', 'min-height:0vh')
        // Check if this is a new item
        if (typeof itemSrc !== 'undefined') {
          this.headerTitle = "Edit Item"
          // Load the form into the DOM.
          let frmSrc = this.formHtmlPath
          let array = frmSrc.split('/')
          let itemUrl = array[0] + '/' + array[1] + '/' + itemSrc
          // todo try to grab local pouch version of item
          let itemHtml = await fetch(itemUrl)
          this.itemHtmlText = await itemHtml.text()
          Tangy.editor.setData(this.itemHtmlText)
        console.log("itemHtmlText: " + JSON.stringify(this.itemHtmlText))
        } else {
          this.headerTitle = "Create Item"
          this.itemHtmlText = ''
          this.itemOrder = null
          this.itemOrderDisabled = true;
        }
      }

      async saveItem(event) {
        this.itemFilename = event.currentTarget.dataItemSrc
        this.itemId = event.currentTarget.dataItemId
        let itemTitle = this.$.itemTitle.value
        let itemHtmlText = Tangy.editor.getData();
//        this.itemHtmlText = event.currentTarget.parentElement.children[0].value
        let project = window.location.pathname.split("/")[3];
        let item = {}
        item.projectName = project
        item.formHtmlPath = this.formHtmlPath
        item.itemFilename = this.itemFilename
        item.itemId = this.itemId
        item.itemTitle = itemTitle
        item.itemHtmlText = itemHtmlText
//        item.itemOrder = this.itemOrder
        // todo: eventually we will have a UI to re-arrange the items in the item listing, but for now, get the value from our form.
        item.itemOrder = this.$.itemOrder.value
        if (item.itemFilename == 'undefined') {
          let size = this.items.length
          item.itemOrder = size+1
        }
        // pass items to help saveItem create new item name
        let response = await TangyUtils.saveItem(item, this.items);
        console.log("response: " + JSON.stringify(response));
      }

    }

    window.customElements.define(TangyFormApp.is, TangyFormApp);
  </script>
</dom-module>
